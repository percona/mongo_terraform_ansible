# Deploy hardware for MongoDB clusters using Terraform in AWS

## Pre-requisites

1. Install [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
2. Authenticate your shell session with your AWS account IAM credentials

    ```
    aws configure
    ``` 

3. Clone this repository on your machine and `cd` to it

    ```
    cd mongo_terraform_ansible/terraform/aws
    ```

4. Initialize Terraform 

    ```
    terraform init
    ```

## Quick guide

1. Prepare the configuration file

    ```
    vi variables.tf
    ```

2. Run Terraform to create the resources

    ```
    terraform apply
    ``` 

3. Add the SSH configuration file generated by Terraform to your machine to connect easily. For example: 

    ```
    cat ssh_config* >> ~/.ssh/config
    ```

    Modify the config as needed depending on your environment

4. Copy the generated inventory for Ansible
    ```
    cp inventory* ../../ansible/
    ```

- Look inside the [ansible](../../ansible) folder for instructions to complete the deployment of the MongoDB clusters/replica sets

- The deployment of the resources required for a 2-shard cluster with Terraform takes around 1 minute

- You can run `terraform output -json` to see the access/secret keys generated for the S3 bucket created to store backups

## Connecting to the created instances

If you copied the generated configuration to ssh_config, no parameters should be needed. Example:

```
    ssh my-env-name-mongodb-cfg01
```

## Minimum variables to customize

These are the ones you have to care about for a quick deploy with default values:

- env_tag

    This is just a prefix for the name of your environment. Make sure nobody else is using the same one in the project

- aws_ssh_users

    List of SSH usernames and path to their public keys to configure access to your instances

- my_ssh_user

    Your own SSH user. This is used to generate an SSH config file for you

- enable_ssh_gateway

    Wether you can SSH directly or through a jump host. This is used to generate an SSH config file for you
