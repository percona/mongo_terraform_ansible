# Deploy hardware for MongoDB clusters using Terraform in Google Cloud

Creates the following resources:
 
- VPC
- Subnets
- Firewall rules
- VM instances for each component
- Persistent volumes for data-bearing members
- Cloud Storage bucket for storing backups
- Ansible inventory
- SSH configuration

## Pre-requisites

1. Install Google Cloud SDK https://cloud.google.com/sdk/docs/install#linux

2. Authenticate your shell session with your Google account credentials

    ```
    gcloud auth application-default login
    ``` 

3. Clone this repository on your machine and `cd` to it

    ```
    cd mongo_terraform_ansible/terraform/gcp
    ```

4. Initialize Terraform 

    ```
    terraform init
    ```

## Quick guide

1. Review the configuration file and set the proper values. See the next section for details. 

    ```
    vi variables.tf
    ```

2. Run Terraform to create the resources

    ```
    terraform apply
    ``` 

3. Add the SSH configuration files generated by Terraform to your machine's configuration. For example: 

    ```
    cat ssh_config* >> ~/.ssh/config
    ```

    Modify the config as needed depending on your environment

4. (Optional) Copy the generated inventories to the [ansible](../../ansible) folder
    ```
    cp inventory* ../../ansible/
    ```

5. Look inside the [ansible](../../ansible) folder for instructions to complete the deployment of the MongoDB clusters/replica sets using Ansible

- The deployment of the resources required for a 2-shard cluster with Terraform takes around 1 minute

- You can run `terraform output -json` to see the access/secret keys generated for the Cloud Storage bucket created to store backups

## Connecting to the created instances

If you copied the generated configuration to ssh_config, no parameters should be needed. Example:

```
    ssh my-cluster-name-mongodb-cfg01
```

## Minimum variables to customize

Before deploying, make sure to edit `variables.tf`. These are the variables you have to care about for a quick deploy with mostly default values:

- prefix
 
    Prefix to be applied to the resources created, change it to avoid collisions with other users environments

- clusters

    By default we deploy 1 sharded cluster, but more can be added. Make sure to change the default name to avoid duplicates. The configuration for each cluster can be customized by adding the optional values listed.

- replsets

    If you want to provision any replica sets (non-sharded), set this variable. Make sure to change the default name to avoid duplicates.

- project_id

    This is the GCP project to use for deploying resources

- gce_ssh_users

    List of SSH usernames and path to their public key file on your machine to configure access to the created instances

- my_ssh_user

    Your own SSH user name. This is used to generate an SSH config file for you to login easily